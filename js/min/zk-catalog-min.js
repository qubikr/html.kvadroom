var ZKCatalog={};ZKCatalog.Search=function(){this.init=function(){function t(t,e){i.set("items",e),i.set("query",t)}function e(t){return t=$.trim(t),t=t.replace(/[\.,\/#!$%\^&\*;:"'(){}=_`~()]/g,""),t.replace(/\s{2,}/g," "),t}function a(a){a&&a.length>1?ZKCatalog.data.getObjects(function(n){if(n.success){var i=n.objects,r=_.filter(i,function(t){if(t.name&&t.name.length>2){var n=t.name.toLowerCase(),i=a.toLowerCase();if(i=e(i),n=e(n),n.search(i)>0&&n&&n.length>2)return t}});t(a,r)}else t(a,{})}):t(a,{})}var n={},i=new Ractive({el:"#search-result",template:'<ul class="search-selector {{#if items.length > 0}}active{{/if}}">{{#items}}<li on-click="goUrl">{{{hl(name, query)}}}</li>{{/items}}</ul>',data:{hl:function(t,e){e=$.trim(e),e=e.replace(/[\.,\/#!$%\^&\*;:"'(){}=_`~()]/g,""),e.replace(/\s{2,}/g," ");var a=e.split(" ");a.sort(function(t,e){return e.length-t.length});for(var n=0,i=a.length;i>n;n++){var r=new RegExp(a[n],"gi");t=t.replace(r,function(t){return"<span>"+t+"</span>"})}return t},query:"",items:[]}});i.on("goUrl",function(t){document.location.href=t.context.url});var r=new UIClickOutside($("#search-result"),function(){i.set("items",[]),i.set("query","")});return r.bind(),$(document).on("keydown.searchResultNavigate",function(t){var e=$("#search-result .search-selector li"),a=e.filter(".active");if(a.length>0)switch(t.keyCode){case 40:a.next().length>0&&(a.next().addClass("active"),a.removeClass("active"));break;case 38:a.prev().length>0&&(a.prev().addClass("active"),a.removeClass("active"));break;case 13:a.click()}else e.filter(":first").addClass("active")}),$(".search-string-zk input.entry").on("keyup",function(t){a(27==t.keyCode?"":$(this).val())}),this}},ZKCatalog.Data=function(t,e){var a=null,n=null;this.getCurrentObject=function(e){return n?e(n):void $.ajax({url:"json/zk.json?r_id="+t,data:{},dataType:"json",success:function(t){n=t,e(t)}})},this.getObjects=function(n){return a?n(a):void $.ajax({url:"json/zk_objects.json?r_id="+t+"&type_id="+e,data:{},dataType:"json",success:function(t){a=t,n(t)}})}},ZKCatalog.Map=function(){$(".zk-catalog-block").KVLoadingElement({overlay:!0,invert:!0}),this.init=function(){var t=$(".map-zk-catalog").data();if(t&&t.center){var e=new GeoMap({id:"map-zk-catalog",fullScreenTrigger:"#fullscreen-trigger",zoom:5,clusterer:!0,controls:!0,center:t.center,onInit:function(t){ZKCatalog.data.getCurrentObject(function(t){if(t.success)var a=new e.Pin({type:"basic",avoidClusterer:!0,center:[parseFloat(t.data.lat),parseFloat(t.data.lon)],content:'<a href="'+t.data.url+'">'+t.data.name+"</a>"})}),ZKCatalog.data.getObjects(function(a){a.success&&_.each(a.objects,function(t){new e.Pin({type:"basic_small",center:[parseFloat(t.lat),parseFloat(t.lon)],zoomRelatedIcon:!0,zoomRelatedIconFactor:12,content:'<a href="'+t.url+'">'+t.name+"</a>"})}),t.fitCluster(),$(".zk-catalog-block").KVLoadingElement("stop")})}});e.init()}return this}},ZKCatalog.init=function(){var t=$(".map-zk-catalog");this.data=new this.Data(t.data("region_id"),t.data("type_id")),this.map=(new this.Map).init(),this.search=(new this.Search).init()},$(function(){ZKCatalog.init()});