var GeoMap=function(e){var n=this,o,t=[],i=$.extend({id:"map",fullScreenTrigger:!1,center:[55.76,37.64],zoom:10,layer:"map",controls:!1,onInit:function(){},onFullscreenEnter:function(){},onFullscreenExit:function(){}},e),a=$("#"+i.id),l=20;i.fullScreenTrigger&&$(i.fullScreenTrigger).off("click").on("click",function(e){e.preventDefault(),n.enterFullScreen()});var c=function(){o=new ymaps.Map(i.id,{center:i.center,zoom:i.zoom}),i.controls===!0&&f()},s=function(e,n,i,a,l,c,s,r){var f="",d="";r&&(f='<a class="close" title="Закрыть" href="#"><i></i></a>',d="closeable"),console.log(f);var u=this,m=_.uniqueId("balloon"),p=$(),h=!1,v=new ymaps.Placemark(n,{iconContent:'<div class="map-balloon hidden disabled '+d+'" id="'+m+'"><div class="inner"><span class="content-inner" style="white-space: nowrap">'+i+"</span>"+f+"</div></div>"},{iconImageHref:"",iconImageSize:20,iconImageOffset:10});v.events.add("overlaychange",function(){p=$("#"+m),p.find(".close").on("click",function(e){e.preventDefault(),u.hide()}),a&&a()}),v.events.add("click",function(){l&&l()}),o.geoObjects.add(v);var g=function(){u.hide()};this.getId=function(){return m},this.show=function(n){p.removeClass("hidden"),p.css({marginTop:-(p.height()/2-(c?c:0)),marginLeft:s?s:0,width:250}),setTimeout(function(){console.log(p.find(".content-inner").width()+40),p.css({width:p.find(".content-inner").width()+40})},100),o.events.add("click",g),setTimeout(function(){p.removeClass("disabled")},500),_.each(t,function(e){e.getId()!=u.getId()&&e.hide()}),h!==!0&&(h=n),e.options.set("zIndex",100)},this.hide=function(){e.options.set("zIndex",1),h!==!0&&(p.addClass("disabled"),setTimeout(function(){p.addClass("hidden")},500),o.events.remove("click",g))},t.push(this)},r=function(e){var n=ymaps.util.bounds.getCenterAndZoom(e,[a.width(),a.height()]);o.setCenter(i.center),o.setZoom(n.zoom)},f=function(){function e(e){var n=$.extend({top:0,left:0,right:0,title:"",icon_class:"",onSelect:function(){},onDeselect:function(){}},e),t='<div id="map-type" title="$[data.title]" class="map-view-control-button [if state.selected]map-view-control-button-selected[endif]"><i class="icon-font $[data.icon_class]"></i></div>',i=ymaps.templateLayoutFactory.createClass(t),a=new ymaps.control.Button({data:{title:n.title,icon_class:n.icon_class}},{layout:i,selectOnClick:!0});a.events.add("select",function(){n.onSelect()}).add("deselect",function(){n.onDeselect()});var l={};return n.left!==!1?l.left=n.left:l.right=n.right,l.top=n.top,o.controls.add(a,l),a}var n='<div class="map-view-control"><div id="map-zoom-in" class="map-view-control-button"><i class="icon-font icon-font-plus"></i></div><div id="map-zoom-out" class="map-view-control-button"><i class="icon-font icon-font-minus"></i></div></div>',t=ymaps.templateLayoutFactory.createClass(n,{build:function(){t.superclass.build.call(this),$("#map-zoom-in").bind("click",ymaps.util.bind(this.zoomIn,this)),$("#map-zoom-out").bind("click",ymaps.util.bind(this.zoomOut,this))},clear:function(){$("#map-zoom-in").unbind("click"),$("#map-zoom-out").unbind("click"),t.superclass.clear.call(this)},zoomIn:function(){this.events.fire("zoomchange",{oldZoom:o.getZoom(),newZoom:o.getZoom()+1})},zoomOut:function(){this.events.fire("zoomchange",{oldZoom:o.getZoom(),newZoom:o.getZoom()-1})}}),i=new ymaps.control.SmallZoomControl({layout:t});o.controls.add(i,{left:0,top:0}),o.controls.add(i),e({top:80,left:0,title:"Режим спутника",icon_class:"icon-font-map_sputnik",onSelect:function(){o.setType("yandex#satellite")},onDeselect:function(){o.setType("yandex#map")}})};this.panCenter=function(){var e=[parseFloat(i.center[0]),parseFloat(i.center[1])];o.panTo(e,{delay:0})},this.Pin=function(e){var n=this,t=$.extend({center:[55.76,37.64],content:"",title:"",type:"basic",balloonCloseButton:!1,onReady:function(){},onClick:function(){},onBalloonReady:function(){},onBalloonClick:function(){}},e),i=_.uniqueId("pin"),a=t.title?'<span class="marker-title">'+t.title+"</span>":"",l=$(),c={};switch(t.type){case"basic":c={className:"maps-marker-basic",size:[31,43],offset:[-21,-49],balloonOffsetY:-27,balloonOffsetX:18};break;case"basic_small":c={className:"maps-marker-basic_small",size:[19,25],offset:[-10,-25],balloonOffsetY:-17,balloonOffsetX:18}}var r=new ymaps.Placemark(t.center,{iconContent:'<span class="maps-marker-icon '+c.className+'" id="'+i+'">'+a+"</span>"},{iconImageHref:"",iconImageSize:c.size,iconImageOffset:c.offset});o.geoObjects.add(r);var f=null;t.content&&(f=new s(r,t.center,t.content,t.onBalloonReady,t.onBalloonClick,c.balloonOffsetY,c.balloonOffsetX,t.balloonCloseButton)),r.events.add("click",function(){t.onClick(),n.showBalloon()}),r.events.add("overlaychange",function(){t.onReady&&t.onReady(),l=$("#"+i);var e=l.find(".marker-title");e.css({bottom:-e.outerHeight()})}),this.pointMap=function(){o.setCenter(t.center)},this.showBalloon=function(e){f&&f.show(e)},this.hideBalloon=function(){f&&f.hide()}},this.Area=function(e){var n=$.extend({coords:[],content:"",balloonCloseButton:!1,onReady:function(){},onClick:function(){},onBalloonReady:function(){},onBalloonClick:function(){}},e),t=new ymaps.GeoObject({geometry:{type:"Polygon",coordinates:n.coords,fillRule:"nonZero"}},{fillColor:"rgba(255, 0, 0, 0.1)",strokeColor:"rgba(255, 0, 0, 1)",opacity:1,strokeWidth:2});o.geoObjects.add(t);var i=t.geometry.getBounds(),a=null,l=[i[0][0]+(i[1][0]-i[0][0])/2,i[0][1]+(i[1][1]-i[0][1])/2];if(n.content){var c=[l[0],i[1][1]];a=new s(t,c,n.content,n.onBalloonReady,n.onBalloonClick,0,0,n.balloonCloseButton)}t.events.add("click",function(){n.onClick(),a&&a.show()}),t.events.add("overlaychange",function(){n.onReady&&n.onReady()}),this.pointMap=function(){o.setCenter(l)},this.fitMap=function(){r(i)},this.showBalloon=function(e){a&&a.show(e)},this.hideBalloon=function(){a&&a.hide()}};var d=function(e){var n=0,t=0,i=$(".map-fullscreen-overlay"),l=60;n=i.width()-2*l,t=i.height()-2*l;var c=null;e>0&&(c=setInterval(function(){o.container.fitToViewport()},1)),a.parent().animate({width:n,height:t,top:l,left:l},e,function(){clearInterval(c),o&&o.container&&o.container.fitToViewport()})},u=function(e){var n={};a.parent().data("originalSize")?n=a.parent().data("originalSize"):(n={h:a.parent().height()},a.parent().data("originalSize",n)),a.parent().addClass("map-fullscreen");var t=$("<div/>");t.addClass("map-fs-dummy").css({height:n.h}),a.parent().after(t),a.parent().css({width:t.width(),height:t.height(),top:t.offset().top-$(document).scrollTop(),left:t.offset().left}),o&&o.container&&o.container.fitToViewport(),e&&e()};this.enterFullScreen=function(){$("body").append('<div class="map-fullscreen-overlay"><a class="map-fullscreen-close kiv-e" href="#"><i class="icon-font icon-font-cross"></i></a></div>'),$("html,body").css("overflow","hidden"),setTimeout(function(){$(".map-fullscreen-overlay").addClass("ready")},50),$(document).off("keyup.map-fullscreen").on("keyup.map-fullscreen",function(e){27==e.keyCode&&n.exitFullScreen()}),$(".map-fullscreen-close").off("click").on("click",function(e){e.preventDefault(),n.exitFullScreen()}),i.fullScreenTrigger&&$(i.fullScreenTrigger).hide(),u(function(){d(l),setTimeout(function(){$(window).off("resize.mapFullscreen").on("resize.mapFullscreen",function(){d(0)}),setTimeout(function(){$(window).trigger("resize")},50)},l)})},this.exitFullScreen=function(){$(window).off("resize.mapFullscreen"),i.fullScreenTrigger&&$(i.fullScreenTrigger).show();var e=$(".map-fs-dummy"),n=setInterval(function(){o.container.fitToViewport()},1);$(".map-fullscreen-overlay").removeClass("ready"),setTimeout(function(){$(".map-fullscreen-overlay").remove()},400),a.parent().animate({width:e.width(),height:e.height(),top:e.offset().top-$(document).scrollTop(),left:e.offset().left},l,function(){a.parent().removeClass("map-fullscreen"),e.remove(),clearInterval(n),$("html,body").css("overflow","auto"),o.container.fitToViewport()}),o.container.fitToViewport()},this.init=function(){"undefined"!=typeof ymaps?(c(),i.onInit(n)):$.getScript("http://api-maps.yandex.ru/2.0-stable/?load=package.full&lang=ru-RU",function(){ymaps.ready(function(){c(),i.onInit(n)})})}};