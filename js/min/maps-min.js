var GeoMap=function(e){var n=this,o,t=[],i=$.extend({id:"map",fullScreenTrigger:!1,center:[55.76,37.64],zoom:10,layer:"map",onInit:function(){},onFullscreenEnter:function(){},onFullscreenExit:function(){}},e),a=$("#"+i.id),l=20;i.fullScreenTrigger&&$(i.fullScreenTrigger).off("click").on("click",function(e){e.preventDefault(),n.enterFullScreen()});var c=function(){o=new ymaps.Map(i.id,{center:i.center,zoom:i.zoom})},s=function(e,n,i,a,l,c,s,r){var f="";r&&(f='<a class="close" title="Закрыть" href="#"><i></i></a>');var u=this,d=_.uniqueId("balloon"),p=$(),m=!1,h=new ymaps.Placemark(n,{iconContent:'<div class="map-balloon disabled" id="'+d+'"><div class="inner">'+i+f+"</div></div>"},{iconImageHref:"",iconImageSize:20,iconImageOffset:10,zIndex:2});h.events.add("overlaychange",function(){p=$("#"+d),p.css({marginTop:-(p.height()/2-(c?c:0)),marginLeft:s?s:0}),p.find(".close").on("click",function(){u.hide()}),a&&a()}),h.events.add("click",function(){l&&l()}),o.geoObjects.add(h);var g=function(){u.hide()};this.getId=function(){return d},this.show=function(n){p.removeClass("disabled"),o.events.add("click",g),_.each(t,function(e){e.getId()!=u.getId()&&e.hide()}),m!==!0&&(m=n),e.options.set("zIndex",100)},this.hide=function(){e.options.set("zIndex",1),m!==!0&&(p.addClass("disabled"),o.events.remove("click",g))},t.push(this)},r=function(e){var n=ymaps.util.bounds.getCenterAndZoom(e,[a.width(),a.height()]);o.setCenter(i.center),o.setZoom(n.zoom)};this.Pin=function(e){var n=this,t=$.extend({center:[55.76,37.64],content:"",title:"",type:"basic",balloonCloseButton:!1,onReady:function(){},onClick:function(){},onBalloonReady:function(){},onBalloonClick:function(){}},e),i=_.uniqueId("pin"),a=t.title?'<span class="marker-title">'+t.title+"</span>":"",l=$(),c={};switch(t.type){case"basic":c={className:"maps-marker-basic",size:[31,43],offset:[-21,-49],balloonOffsetY:-25,balloonOffsetX:18};break;case"basic_small":c={className:"maps-marker-basic_small",size:[19,25],offset:[-10,-25],balloonOffsetY:-17,balloonOffsetX:18}}var r=new ymaps.Placemark(t.center,{iconContent:'<span class="maps-marker-icon '+c.className+'" id="'+i+'">'+a+"</span>"},{iconImageHref:"",iconImageSize:c.size,iconImageOffset:c.offset});o.geoObjects.add(r);var f=null;t.content&&(f=new s(r,t.center,t.content,t.onBalloonReady,t.onBalloonClick,c.balloonOffsetY,c.balloonOffsetX,t.balloonCloseButton)),r.events.add("click",function(){console.log("xxx"),o.panTo(t.center,{delay:0}),t.onClick(),n.showBalloon()}),r.events.add("overlaychange",function(){t.onReady&&t.onReady(),l=$("#"+i);var e=l.find(".marker-title");e.css({bottom:-e.outerHeight()})}),this.pointMap=function(){o.setCenter(t.center)},this.showBalloon=function(e){f&&f.show(e)},this.hideBalloon=function(){f&&f.hide()}},this.Area=function(e){var n=$.extend({coords:[],content:"",balloonCloseButton:!1,onReady:function(){},onClick:function(){},onBalloonReady:function(){},onBalloonClick:function(){}},e),t=new ymaps.GeoObject({geometry:{type:"Polygon",coordinates:n.coords,fillRule:"nonZero"}},{fillColor:"rgba(255, 0, 0, 0.1)",strokeColor:"rgba(255, 0, 0, 1)",opacity:1,strokeWidth:2});o.geoObjects.add(t);var i=t.geometry.getBounds(),a=null,l=[i[0][0]+(i[1][0]-i[0][0])/2,i[0][1]+(i[1][1]-i[0][1])/2];if(n.content){var c=[l[0],i[1][1]];a=new s(t,c,n.content,n.onBalloonReady,n.onBalloonClick,0,0,n.balloonCloseButton)}t.events.add("click",function(){o.panTo(l,{delay:0}),n.onClick(),a&&a.show()}),t.events.add("overlaychange",function(){n.onReady&&n.onReady()}),this.pointMap=function(){o.setCenter(l)},this.fitMap=function(){r(i)},this.showBalloon=function(e){a&&a.show(e)},this.hideBalloon=function(){a&&a.hide()}};var f=function(e){var n=0,t=0,i=$(".map-fullscreen-overlay"),l=60;n=i.width()-2*l,t=i.height()-2*l;var c=null;e>0&&(c=setInterval(function(){o.container.fitToViewport()},1)),a.parent().animate({width:n,height:t,top:l,left:l},e,function(){clearInterval(c),o&&o.container&&o.container.fitToViewport()})},u=function(e){var n={};a.parent().data("originalSize")?n=a.parent().data("originalSize"):(n={h:a.parent().height()},a.parent().data("originalSize",n)),a.parent().addClass("map-fullscreen");var t=$("<div/>");t.addClass("map-fs-dummy").css({height:n.h}),a.parent().after(t),a.parent().css({width:t.width(),height:t.height(),top:t.offset().top-$(document).scrollTop(),left:t.offset().left}),o&&o.container&&o.container.fitToViewport(),e&&e()};this.enterFullScreen=function(){$("body").append('<div class="map-fullscreen-overlay"><a class="map-fullscreen-close kiv-e" href="#"><i class="icon-font icon-font-cross"></i></a></div>'),$("html,body").css("overflow","hidden"),setTimeout(function(){$(".map-fullscreen-overlay").addClass("ready")},50),$(document).off("keyup.map-fullscreen").on("keyup.map-fullscreen",function(e){27==e.keyCode&&n.exitFullScreen()}),$(".map-fullscreen-close").off("click").on("click",function(e){e.preventDefault(),n.exitFullScreen()}),i.fullScreenTrigger&&$(i.fullScreenTrigger).hide(),u(function(){f(l),setTimeout(function(){$(window).off("resize.mapFullscreen").on("resize.mapFullscreen",function(){f(0)}),setTimeout(function(){$(window).trigger("resize")},50)},l)})},this.exitFullScreen=function(){$(window).off("resize.mapFullscreen"),i.fullScreenTrigger&&$(i.fullScreenTrigger).show();var e=$(".map-fs-dummy"),n=setInterval(function(){o.container.fitToViewport()},1);$(".map-fullscreen-overlay").removeClass("ready"),setTimeout(function(){$(".map-fullscreen-overlay").remove()},400),a.parent().animate({width:e.width(),height:e.height(),top:e.offset().top-$(document).scrollTop(),left:e.offset().left},l,function(){a.parent().removeClass("map-fullscreen"),e.remove(),clearInterval(n),$("html,body").css("overflow","auto"),o.container.fitToViewport()}),o.container.fitToViewport()},this.init=function(){"undefined"!=typeof ymaps?(c(),i.onInit(n)):$.getScript("http://api-maps.yandex.ru/2.0-stable/?load=package.full&lang=ru-RU",function(){ymaps.ready(function(){c(),i.onInit(n)})})}};