var GeoMap=function(n){var e=this,o,t=[],i=$.extend({id:"map",fullScreenTrigger:!1,center:[55.76,37.64],zoom:10,layer:"map",onInit:function(){},onFullscreenEnter:function(){},onFullscreenExit:function(){}},n),c=$("#"+i.id);i.fullScreenTrigger&&$(i.fullScreenTrigger).off("click").on("click",function(n){n.preventDefault(),e.enterFullScreen()});var a=function(){o=new ymaps.Map(i.id,{center:i.center,zoom:i.zoom})},l=function(n,e,i,c,a,l){var r=this,s=_.uniqueId("balloon"),d=$(),f=!1,u=new ymaps.Placemark(n,{iconContent:'<div class="map-balloon disabled" id="'+s+'"><div class="inner">'+e+"</div></div>"},{iconImageHref:"",iconImageSize:20,iconImageOffset:10,zIndex:2});u.events.add("overlaychange",function(){d=$("#"+s),d.css({marginTop:-(d.height()/2-(a?a:0)),marginLeft:l?l:0}),i&&i()}),u.events.add("click",function(){c&&c()}),o.geoObjects.add(u);var h=function(){r.hide()};this.getId=function(){return s},this.show=function(n){d.removeClass("disabled"),o.events.add("click",h),_.each(t,function(n){n.getId()!=r.getId()&&n.hide()}),f!==!0&&(f=n)},this.hide=function(){f!==!0&&(d.addClass("disabled"),o.events.remove("click",h))},t.push(this)},r=function(n){var e=ymaps.util.bounds.getCenterAndZoom(n,[c.width(),c.height()]);o.setCenter(e.center),o.setZoom(e.zoom)};this.Pin=function(n){var e=$.extend({center:[55.76,37.64],content:"",title:"",onReady:function(){},onClick:function(){},onBalloonReady:function(){},onBalloonClick:function(){}},n),t=_.uniqueId("pin"),i=e.title?'<span class="marker-title">'+e.title+"</span>":"",c=$(),a=new ymaps.Placemark(e.center,{iconContent:'<span class="maps-marker-icon maps-marker-basic" id="'+t+'">'+i+"</span>"},{iconImageHref:"",iconImageSize:[31,43],iconImageOffset:[-21,-49]});o.geoObjects.add(a);var r=null;e.content&&(r=new l(e.center,e.content,e.onBalloonReady,e.onBalloonClick,-25,18)),a.events.add("click",function(){o.panTo(e.center,{delay:0}),e.onClick(),r&&r.show()}),a.events.add("overlaychange",function(){e.onReady&&e.onReady(),c=$("#"+t);var n=c.find(".marker-title");n.css({bottom:-n.outerHeight()})}),this.pointMap=function(){o.setCenter(e.center)},this.showBalloon=function(n){r&&r.show(n)},this.hideBalloon=function(){r&&r.hide()}},this.Area=function(n){var e=$.extend({coords:[],content:"",onReady:function(){},onClick:function(){},onBalloonReady:function(){},onBalloonClick:function(){}},n),t=new ymaps.GeoObject({geometry:{type:"Polygon",coordinates:e.coords,fillRule:"nonZero"}},{fillColor:"rgba(255, 0, 0, 0.1)",strokeColor:"rgba(255, 0, 0, 1)",opacity:1,strokeWidth:2});o.geoObjects.add(t);var i=t.geometry.getBounds(),c=null,a=[i[0][0]+(i[1][0]-i[0][0])/2,i[0][1]+(i[1][1]-i[0][1])/2];if(e.content){var s=[a[0],i[1][1]];c=new l(s,e.content,e.onBalloonReady,e.onBalloonClick)}t.events.add("click",function(){o.panTo(a,{delay:0}),e.onClick(),c&&c.show()}),t.events.add("overlaychange",function(){e.onReady&&e.onReady()}),this.pointMap=function(){o.setCenter(a)},this.fitMap=function(){r(i)},this.showBalloon=function(n){c&&c.show(n)},this.hideBalloon=function(){c&&c.hide()}},this.enterFullScreen=function(){$("body").append('<div class="map-fullscreen-overlay"><a class="map-fullscreen-close kiv-e" href="#"><i class="icon-font icon-font-cross"></i></a></div>'),$("html,body").css("overflow","hidden"),$(document).off("keyup.map-fullscreen").on("keyup.map-fullscreen",function(n){27==n.keyCode&&e.exitFullScreen()}),c.parent().addClass("map-fullscreen").css({position:"fixed",top:"50%",left:"50%",marginLeft:-470,marginTop:-300,width:940,height:600,zIndex:10001}),c.css({height:600}),o.container.fitToViewport(),$(".map-fullscreen-close").off("click").on("click",function(n){n.preventDefault(),e.exitFullScreen()}),i.fullScreenTrigger&&$(i.fullScreenTrigger).hide()},this.exitFullScreen=function(){$(".map-fullscreen-overlay").remove(),c.parent().removeClass("map-fullscreen").css({position:"static",width:"100%",marginLeft:0,marginTop:0,height:400}),c.css({height:400}),o.container.fitToViewport(),$("html,body").css("overflow","auto"),i.fullScreenTrigger&&$(i.fullScreenTrigger).show()},this.init=function(){"undefined"!=typeof ymaps?(a(),i.onInit(e)):$.getScript("http://api-maps.yandex.ru/2.0-stable/?load=package.full&lang=ru-RU",function(){ymaps.ready(function(){a(),i.onInit(e)})})}};