var GeoMap=function(e){var n=this,t,o=[],i=[],a=$.extend({id:"map",clusterer:!1,fullScreenTrigger:!1,center:[55.76,37.64],zoom:10,layer:"map",controls:!1,onInit:function(){},onFullscreenEnter:function(){},onFullscreenExit:function(){}},e);this.getMap=function(){return t};var l=$("#"+a.id),s=20,c=null;a.fullScreenTrigger&&$(a.fullScreenTrigger).off("click").on("click",function(e){e.preventDefault(),n.enterFullScreen()}),this.setLoading=function(){l.parent().KVLoadingElement({invert:!0,overlay:!0,big:!0,append:!0,zIndex_overlay:1e3}),l.parent().find("loading-dots").addClass("loading-dots-invert")},this.unsetLoading=function(){l.parent().KVLoadingElement("stop")};var r=function(){t=new ymaps.Map(a.id,{center:a.center,zoom:a.zoom}),a.controls===!0&&u(),a.clusterer===!0&&n.createClusterer()},d=function(e,n,i,a,l,s,c,r){var d="",f="",u=!1;r&&(d='<a class="close" title="Закрыть" href="#"><i></i></a>',f="closeable");var p=this,m=_.uniqueId("balloon"),h=$(),v=!1,g=new ymaps.Placemark(n,{iconContent:'<div class="map-balloon hidden disabled '+f+'" id="'+m+'"><div class="inner"><span class="content-inner" style="white-space: nowrap">'+i+"</span>"+d+"</div></div>"},{iconImageHref:"",iconImageSize:20,iconImageOffset:10});g.options.set("zIndex",-1),g.events.add("overlaychange",function(){h=$("#"+m),h.find(".close").on("click",function(e){e.preventDefault(),p.hide()}),a&&a()}),g.events.add("click",function(){l&&l()}),t.geoObjects.add(g);var y=function(){p.hide()};this.getId=function(){return m},this.show=function(n){u||(h.removeClass("hidden"),h.css({marginTop:-(h.height()/2-(s?s:0)),marginLeft:c?c:0,width:250}),u=!0,setTimeout(function(){console.log(h.find(".content-inner").width()+40),h.css({width:h.find(".content-inner").width()+40})},100),t.events.add("click",y),setTimeout(function(){h.removeClass("disabled")},500),_.each(o,function(e){e.getId()!=p.getId()&&e.hide()}),v!==!0&&(v=n),g.options.set("zIndex",1e3),e.options.set("zIndex",1e3))},this.hide=function(){if(v!==!0){if(!u)return;u=!1,h.addClass("disabled"),setTimeout(function(){h.addClass("hidden")},500),t.events.remove("click",y)}},o.push(this)},f=function(e){var n=ymaps.util.bounds.getCenterAndZoom(e,[l.width(),l.height()]);t.setCenter(a.center),t.setZoom(n.zoom)},u=function(){function e(e){var n=$.extend({top:0,left:0,right:0,title:"",icon_class:"",onSelect:function(){},onDeselect:function(){}},e),o='<div id="map-type" title="$[data.title]" class="map-view-control-button [if state.selected]map-view-control-button-selected[endif]"><i class="icon-font $[data.icon_class]"></i></div>',i=ymaps.templateLayoutFactory.createClass(o),a=new ymaps.control.Button({data:{title:n.title,icon_class:n.icon_class}},{layout:i,selectOnClick:!0});a.events.add("select",function(){n.onSelect()}).add("deselect",function(){n.onDeselect()});var l={};return n.left!==!1?l.left=n.left:l.right=n.right,l.top=n.top,t.controls.add(a,l),a}var n='<div class="map-view-control"><div id="map-zoom-in" data-big="x" class="map-view-control-button"><i class="icon-font icon-font-plus"></i></div><div id="map-zoom-out" class="map-view-control-button"><i class="icon-font icon-font-minus"></i></div></div>',o=ymaps.templateLayoutFactory.createClass(n,{build:function(){o.superclass.build.call(this),$("#map-zoom-in").bind("click",ymaps.util.bind(this.zoomIn,this)),$("#map-zoom-out").bind("click",ymaps.util.bind(this.zoomOut,this))},clear:function(){$("#map-zoom-in").unbind("click"),$("#map-zoom-out").unbind("click"),o.superclass.clear.call(this)},zoomIn:function(){this.events.fire("zoomchange",{oldZoom:t.getZoom(),newZoom:t.getZoom()+1})},zoomOut:function(){this.events.fire("zoomchange",{oldZoom:t.getZoom(),newZoom:t.getZoom()-1})}}),i=new ymaps.control.SmallZoomControl({layout:o});t.controls.add(i,{left:0,top:0}),t.controls.add(i),e({top:80,left:0,title:"Режим спутника",icon_class:"icon-font-map_sputnik",onSelect:function(){t.setType("yandex#satellite")},onDeselect:function(){t.setType("yandex#map")}})};this.fitCluster=function(){c&&t.setBounds(c.getBounds(),{checkZoomRange:!0})},this.panCenter=function(){var e=[parseFloat(a.center[0]),parseFloat(a.center[1])];t.panTo(e,{delay:0})},this.Pin=function(e){var n=this,o=$.extend({center:[55.76,37.64],content:"",title:"",avoidClusterer:!1,zIndex:!1,type:"basic",balloonCloseButton:!0,onReady:function(){},onClick:function(){},onBalloonReady:function(){},onBalloonClick:function(){}},e),i=_.uniqueId("pin"),a=o.title?'<span class="marker-title">'+o.title+"</span>":"",l=$(),s={};switch(o.type){case"basic":s={className:"maps-marker-basic",size:[31,43],offset:[-21,-49],balloonOffsetY:-27,balloonOffsetX:18};break;case"basic_small":s={className:"maps-marker-basic_small",size:[19,25],offset:[-10,-25],balloonOffsetY:-17,balloonOffsetX:18}}var r=new ymaps.Placemark(o.center,{iconContent:'<span class="maps-marker-icon '+s.className+'" id="'+i+'">'+a+"</span>"},{iconImageHref:"",iconImageSize:s.size,iconImageOffset:s.offset});o.zIndex&&r.options.set("zIndex",o.zIndex);var f=null;o.content&&(f=new d(r,o.center,o.content,o.onBalloonReady,o.onBalloonClick,s.balloonOffsetY,s.balloonOffsetX,o.balloonCloseButton)),r.events.add("click",function(){o.onClick(),t.panTo(o.center,{delay:0}),n.showBalloon()}),r.events.add("overlaychange",function(){o.onReady&&o.onReady(),l=$("#"+i);var e=l.find(".marker-title");e.css({bottom:-e.outerHeight()})}),c&&o.avoidClusterer!==!0?(c.add(r),t.geoObjects.add(c)):t.geoObjects.add(r),this.pointMap=function(){t.setCenter(o.center)},this.showBalloon=function(e){f&&f.show(e)},this.hideBalloon=function(){f&&f.hide()}},this.Area=function(e){var n=$.extend({coords:[],content:"",balloonCloseButton:!0,onReady:function(){},onClick:function(){},onBalloonReady:function(){},onBalloonClick:function(){}},e),o=new ymaps.GeoObject({geometry:{type:"Polygon",coordinates:n.coords,fillRule:"nonZero"}},{fillColor:"rgba(255, 0, 0, 0.1)",strokeColor:"rgba(255, 0, 0, 1)",opacity:1,strokeWidth:2});t.geoObjects.add(o);var i=o.geometry.getBounds(),a=null,l=[i[0][0]+(i[1][0]-i[0][0])/2,i[0][1]+(i[1][1]-i[0][1])/2];if(n.content){var s=[l[0],i[1][1]];a=new d(o,s,n.content,n.onBalloonReady,n.onBalloonClick,0,0,n.balloonCloseButton)}o.events.add("click",function(){n.onClick(),a&&a.show()}),o.events.add("overlaychange",function(){n.onReady&&n.onReady()}),this.pointMap=function(){t.setCenter(l)},this.fitMap=function(){f(i)},this.showBalloon=function(e){a&&a.show(e)},this.hideBalloon=function(){a&&a.hide()}};var p=function(e){var n=0,o=0,i=$(".map-fullscreen-overlay"),a=60;n=i.width()-2*a,o=i.height()-2*a;var s=null;e>0&&(s=setInterval(function(){t.container.fitToViewport()},1)),l.parent().animate({width:n,height:o,top:a,left:a},e,function(){clearInterval(s),t&&t.container&&t.container.fitToViewport()})},m=function(e){var n={};l.parent().data("originalSize")?n=l.parent().data("originalSize"):(n={h:l.parent().height()},l.parent().data("originalSize",n)),l.parent().addClass("map-fullscreen");var o=$("<div/>");o.addClass("map-fs-dummy").css({height:n.h}),l.parent().after(o),l.parent().css({width:o.width(),height:o.height(),top:o.offset().top-$(document).scrollTop(),left:o.offset().left}),t&&t.container&&t.container.fitToViewport(),e&&e()};this.enterFullScreen=function(){$("body").append('<div class="map-fullscreen-overlay"><a class="map-fullscreen-close kiv-e" href="#"><i class="icon-font icon-font-cross"></i></a></div>'),$("html,body").css("overflow","hidden"),setTimeout(function(){$(".map-fullscreen-overlay").addClass("ready")},50),$(document).off("keyup.map-fullscreen").on("keyup.map-fullscreen",function(e){27==e.keyCode&&n.exitFullScreen()}),$(".map-fullscreen-close").off("click").on("click",function(e){e.preventDefault(),n.exitFullScreen()}),a.fullScreenTrigger&&$(a.fullScreenTrigger).hide(),m(function(){p(s),setTimeout(function(){$(window).off("resize.mapFullscreen").on("resize.mapFullscreen",function(){p(0)}),setTimeout(function(){$(window).trigger("resize")},50)},s)})},this.exitFullScreen=function(){$(window).off("resize.mapFullscreen"),a.fullScreenTrigger&&$(a.fullScreenTrigger).show();var e=$(".map-fs-dummy"),n=setInterval(function(){t.container.fitToViewport()},1);$(".map-fullscreen-overlay").removeClass("ready"),setTimeout(function(){$(".map-fullscreen-overlay").remove()},400),l.parent().animate({width:e.width(),height:e.height(),top:e.offset().top-$(document).scrollTop(),left:e.offset().left},s,function(){l.parent().css({top:0,left:0}),l.parent().removeClass("map-fullscreen"),e.remove(),clearInterval(n),$("html,body").css("overflow","auto"),t.container.fitToViewport()}),t.container.fitToViewport()},this.createClusterer=function(){function e(){var e=t.zoomRange.getCurrent()[1],n=t.getZoom();return n>=e}function n(){return e()?a:i}function o(n){var t;return t=e()?'<div class="map-cluster"><div class="anchor" style="width: '+n[0]+"px; height: "+n[1]+'px"></div></div>':'<div class="map-cluster">$[properties.geoObjects.length]</div>',ymaps.templateLayoutFactory.createClass(t)}var i=[{href:"/i/kvad_map_circ_small.png",size:[43,43],offset:[-21.5,-21.5]},{href:"/i/kvad_map_circ_large.png",size:[60,60],offset:[-10,-25]}],a=[{href:"/i/kvad_marker_list.png",size:[31,43],offset:[-15.5,-21.5]},{href:"/i/kvad_marker_list.png",size:[31,43],offset:[-15.5,-21.5]}];c=new ymaps.Clusterer({clusterIcons:n(),clusterNumbers:[15],clusterIconContentLayout:o(),clusterDisableClickZoom:!1,openBalloonOnClick:!1}),t.geoObjects.add(c),c.createCluster=function(e,t){var i=ymaps.Clusterer.prototype.createCluster.call(this,e,t),a=n();return i.options.set("icons",a),i.options.set("iconContentLayout",o(a[0].size)),i}},this.init=function(){"undefined"!=typeof ymaps?(r(),a.onInit(n)):$.getScript("http://api-maps.yandex.ru/2.0-stable/?load=package.full&lang=ru-RU",function(){ymaps.ready(function(){r(),a.onInit(n)})})}};