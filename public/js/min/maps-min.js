var GeoMap=function(e){var t=this,n,o=[],i=[],a=$.extend({id:"map",clusterer:!1,fullScreenTrigger:!1,center:[55.76,37.64],zoom:10,layer:"map",controls:!1,minClusterSize:2,disableClickZoomCluster:!1,goToFirstRelevantClusterUrl:!1,onZoomChanged:function(e){},onInit:function(){},onFullscreenEnter:function(){},onFullscreenExit:function(){}},e);this.getMap=function(){return n};var l=$("#"+a.id),s=20,c=null;a.fullScreenTrigger&&$(a.fullScreenTrigger).off("click").on("click",function(e){e.preventDefault(),t.enterFullScreen()}),this.setLoading=function(){l.parent().KVLoadingElement({invert:!0,overlay:!0,big:!0,append:!0,zIndex_overlay:1e3}),l.parent().find("loading-dots").addClass("loading-dots-invert")},this.unsetLoading=function(){l.parent().KVLoadingElement("stop")};var r=function(){l.append('<div class="map-copyright"><div>&copy; Квадрум <a target="_blank" href="http://help.kvadroom.ru/legal/maps/">Условия использования</a></div></div>')},f=function(){n=new ymaps.Map(a.id,{center:a.center,zoom:a.zoom}),n.events.add("boundschange",function(e){var t=e.get("oldZoom"),n=e.get("newZoom");n!=t&&a.onZoomChanged(n)}),a.controls===!0&&m(),a.clusterer===!0&&t.createClusterer(),r()};this.Collection=function(){var e=new ymaps.GeoObjectCollection;this.add=function(t){e.add(t.getGeoObject())},this.fitBounds=function(){n.setBounds(e.getBounds()),console.log(e.getBounds())},this.clear=function(){e.removeAll()},this.draw=function(){n.geoObjects.add(e)}};var u=function(e){var t=this,i=$.extend({parent:null,center:[0,0],iconSize:[],content:"",closeable:!0,offsetX:0,offsetY:0,onReady:function(){},onClick:function(){}},e),a="",l="",s=!1;this.isShowed=function(){return s},i.closeable&&(a='<a class="close" title="Закрыть" href="#"><i></i></a>',l="closeable");var c=_.uniqueId("balloon"),r=!1,f=new ymaps.Placemark(i.center,{iconContent:'<div class="map-balloon hidden disabled '+l+'" id="'+c+'"><div class="inner"><span class="content-inner" style="white-space: nowrap">'+i.content+"</span>"+a+"</div></div>"},{iconImageHref:"",iconImageSize:0,iconImageOffset:0});f.options.set("zIndex",-1),f.events.add("overlaychange",function(){t.getElement().find(".close").on("click",function(e){e.preventDefault(),t.hide()}),i.onReady(t.getElement())}),f.events.add("click",function(){i.onClick(t.getElement())}),n.geoObjects.add(f),this.getElement=function(){return $("#"+c)};var u=function(){t.hide()};this.setOption=function(e,t){i[e]=t},this.getId=function(){return c},this.setPosition=function(){var e=i.offsetX?i.offsetX:0;t.getElement().css({marginTop:-(t.getElement().height()/2+i.iconSize[0]/2-(i.offsetY?i.offsetY:0)),width:250,left:e})},this.show=function(e){s||(t.getElement().removeClass("hidden"),this.setPosition(),s=!0,setTimeout(function(){t.getElement().css({width:t.getElement().find(".content-inner").width()+40})},100),n.events.add("click",u),setTimeout(function(){t.getElement().removeClass("disabled")},500),_.each(o,function(e){e.getId()!=t.getId()&&e.hide()}),r!==!0&&(r=e),f.options.set("zIndex",1e6),i.parent.options.set("zIndex",1e6))},this.hide=function(){if(r!==!0){if(!s)return;s=!1,t.getElement().addClass("disabled"),setTimeout(function(){t.getElement().addClass("hidden")},500),n.events.remove("click",u)}},o.push(this)},d=function(e,t){var o=ymaps.util.bounds.getCenterAndZoom(e,[l.width(),l.height()]);n.setCenter(a.center),n.setZoom(t?t:o.zoom)},m=function(){function e(e){var t=$.extend({top:0,left:0,right:0,title:"",icon_class:"",onSelect:function(){},onDeselect:function(){}},e),o='<div id="map-type" title="$[data.title]" class="map-view-control-button [if state.selected]map-view-control-button-selected[endif]"><i class="icon-font $[data.icon_class]"></i></div>',i=ymaps.templateLayoutFactory.createClass(o),a=new ymaps.control.Button({data:{title:t.title,icon_class:t.icon_class}},{layout:i,selectOnClick:!0});a.events.add("select",function(){t.onSelect()}).add("deselect",function(){t.onDeselect()});var l={};return t.left!==!1?l.left=t.left:l.right=t.right,l.top=t.top,n.controls.add(a,l),a}var t='<div class="map-view-control"><div id="map-zoom-in" data-big="x" class="map-view-control-button"><i class="icon-font icon-font-plus"></i></div><div id="map-zoom-out" class="map-view-control-button"><i class="icon-font icon-font-minus"></i></div></div>',o=ymaps.templateLayoutFactory.createClass(t,{build:function(){o.superclass.build.call(this),$("#map-zoom-in").bind("click",ymaps.util.bind(this.zoomIn,this)),$("#map-zoom-out").bind("click",ymaps.util.bind(this.zoomOut,this))},clear:function(){$("#map-zoom-in").unbind("click"),$("#map-zoom-out").unbind("click"),o.superclass.clear.call(this)},zoomIn:function(){this.events.fire("zoomchange",{oldZoom:n.getZoom(),newZoom:n.getZoom()+1})},zoomOut:function(){this.events.fire("zoomchange",{oldZoom:n.getZoom(),newZoom:n.getZoom()-1})}}),i=new ymaps.control.SmallZoomControl({layout:o});n.controls.add(i,{left:0,top:0}),n.controls.add(i),e({top:80,left:0,title:"Режим спутника",icon_class:"icon-font-map_sputnik",onSelect:function(){n.setType("yandex#satellite")},onDeselect:function(){n.setType("yandex#map")}})};this.fitCluster=function(){c&&n.setBounds(c.getBounds(),{checkZoomRange:!0})},this.clearClusterer=function(){c&&c.removeAll()},this.panCenter=function(){var e=[parseFloat(a.center[0]),parseFloat(a.center[1])];n.panTo(e,{delay:0})};var p=function(e){switch(e){case"dot":return{className:"maps-marker-dot",href:"/i/kvad_marker_dot.png",size:[12,12],offset:[-12,-12],balloonOffsetY:0,balloonOffsetX:12};break;case"circle_small":return{className:"maps-marker-circle-small",href:"/i/kvad_cluster_white_25px.png",size:[25,25],offset:[-25,-25],balloonOffsetY:0,balloonOffsetX:16};break;case"circle_medium":return{className:"maps-marker-circle-medium",href:"/i/kvad_cluster_white_35px.png",size:[35,35],offset:[-35,-35],balloonOffsetY:0,balloonOffsetX:21};break;case"circle_big":return{className:"maps-marker-circle-big",href:"/i/kvad_cluster_white_45px.png",size:[45,45],offset:[-45,-45],balloonOffsetY:0,balloonOffsetX:26};break;case"circle_jumbo":return{className:"maps-marker-circle-jumbo",href:"/i/kvad_cluster_white_55px.png",size:[55,55],offset:[-55,-55],balloonOffsetY:0,balloonOffsetX:31};break;case"circle_titan":return{className:"maps-marker-circle-titan",href:"/i/kvad_cluster_white_70px.png",size:[70,70],offset:[-70,-70],balloonOffsetY:0,balloonOffsetX:39};break;case"basic_small":return{className:"maps-marker-basic_small",href:"/i/kvad_marker_dot.png",size:[19,25],offset:[-10,-25],balloonOffsetY:-6,balloonOffsetX:25};break;default:case"basic":return{className:"maps-marker-basic",href:"/i/kvad_marker_basic.png",size:[31,43],offset:[-21,-49],balloonOffsetY:-18,balloonOffsetX:28}}};this.Pin=function(e){var t=this,o=$.extend({center:[55.76,37.64],content:"",counter:"",title:"",avoidMap:!1,avoidClusterer:!1,zIndex:!1,zoomRelatedIcon:!1,zoomRelatedIconFactor:12,type:"basic",url:"",avoidPanningAndBalloon:!1,balloonCloseable:!0,onReady:function(){},onClick:function(){},onBalloonReady:function(){},onBalloonClick:function(){}},e),i=_.uniqueId("pin"),a=o.title?'<span class="marker-title">'+o.title+"</span>":"",l=o.counter&&o.counter>1?'<i class="counter">'+o.counter+"</i>":"",s=function(e){return"basic_small"==e&&o.zoomRelatedIcon&&n.getZoom()<=o.zoomRelatedIconFactor&&(e="dot"),p(e)},r=s(o.type),f=new ymaps.Placemark(o.center,{iconContent:'<span class="maps-marker-icon '+r.className+'" id="'+i+'">'+a+l+"</span>"},{iconImageHref:"",iconImageSize:r.size,iconImageOffset:r.offset,counter:o.counter,url:o.url});o.zIndex&&f.options.set("zIndex",o.zIndex);var d=null,m=null;f.events.add("click",function(){o.onClick(),o.avoidPanningAndBalloon!==!0&&(n.panTo(o.center,{delay:0}),t.showBalloon())}),f.events.add("overlaychange",function(){o.onReady&&o.onReady(),t.hideBalloon(),clearTimeout(m),m=setTimeout(function(){t.changeStyle(o.type)},100)}),c&&o.avoidClusterer!==!0?c.add(f):o.avoidMap!==!0&&n.geoObjects.add(f),this.getGeoObject=function(){return f},this.getBalloon=function(){return d},this.getElement=function(){return $(".maps-marker-icon").filter('[id="'+i+'"]')},this.changeStyle=function(e){var n=s(e);if(f.options.set({iconImageHref:"",iconImageSize:n.size,iconImageOffset:n.offset}),d&&(d.setOption("offsetX",n.balloonOffsetX),d.setOption("offsetY",n.balloonOffsetY),d.setPosition()),o.title){var i=t.getElement().find(".marker-title");i.css({bottom:-i.outerHeight()})}this.getElement().attr("class","maps-marker-icon "+n.className)},this.pointMap=function(){n.setCenter(o.center)},this.showBalloon=function(e){o.content&&(d?d.show():d=new u({parent:f,center:o.center,content:o.content,closeable:o.balloonCloseable,offsetX:r.balloonOffsetX,offsetY:r.balloonOffsetY,iconSize:r.size,onReady:function(e){o.onBalloonReady(e),d.show(),t.changeStyle(o.type)},onClick:o.onBalloonClick}))},this.hideBalloon=function(){d&&d.hide()}},this.Area=function(e){var t=$.extend({coords:[],content:"",balloonCloseable:!0,onReady:function(){},onClick:function(){},onBalloonReady:function(){},onBalloonClick:function(){}},e),o=new ymaps.GeoObject({geometry:{type:"Polygon",coordinates:t.coords,fillRule:"nonZero"}},{fillColor:"rgba(255, 0, 0, 0.1)",strokeColor:"rgba(255, 0, 0, 1)",opacity:1,strokeWidth:2});n.geoObjects.add(o);var i=o.geometry.getBounds(),a=null,l=[i[0][0]+(i[1][0]-i[0][0])/2,i[0][1]+(i[1][1]-i[0][1])/2];if(t.content){var s=[l[0],i[1][1]];a=new u({parent:o,center:s,content:t.content,closeable:t.balloonCloseable,onReady:t.onBalloonReady,onClick:t.onBalloonClick})}o.events.add("click",function(){t.onClick(),a&&a.show()}),o.events.add("overlaychange",function(){t.onReady&&t.onReady()}),this.pointMap=function(){n.setCenter(l)},this.fitMap=function(){d(i)},this.showBalloon=function(e){a&&a.show(e)},this.hideBalloon=function(){a&&a.hide()}};var h=function(e){var t=0,o=0,i=$(".map-fullscreen-overlay"),a=60;t=i.width()-2*a,o=i.height()-2*a;var s=null;e>0&&(s=setInterval(function(){n.container.fitToViewport()},1)),l.parent().animate({width:t,height:o,top:a,left:a},e,function(){clearInterval(s),n&&n.container&&n.container.fitToViewport()})},g=function(e){var t={};l.parent().data("originalSize")?t=l.parent().data("originalSize"):(t={h:l.parent().height()},l.parent().data("originalSize",t)),l.parent().addClass("map-fullscreen");var o=$("<div/>");o.addClass("map-fs-dummy").css({height:t.h}),l.parent().after(o),l.parent().css({width:o.width(),height:o.height(),top:o.offset().top-$(document).scrollTop(),left:o.offset().left}),n&&n.container&&n.container.fitToViewport(),e&&e()};this.enterFullScreen=function(){l.parent().after('<div class="map-fullscreen-overlay"><a class="map-fullscreen-close kiv-e" href="#"><i class="icon-font icon-font-cross"></i></a></div>'),$("html,body").css("overflow","hidden"),setTimeout(function(){$(".map-fullscreen-overlay").addClass("ready")},50),$(document).off("keyup.map-fullscreen").on("keyup.map-fullscreen",function(e){27==e.keyCode&&t.exitFullScreen()}),$(".map-fullscreen-close").off("click").on("click",function(e){e.preventDefault(),t.exitFullScreen()}),a.fullScreenTrigger&&$(a.fullScreenTrigger).hide(),g(function(){h(s),setTimeout(function(){$(window).off("resize.mapFullscreen").on("resize.mapFullscreen",function(){h(0)}),setTimeout(function(){$(window).trigger("resize"),a.onFullscreenEnter()},50)},s)})},this.exitFullScreen=function(){$(window).off("resize.mapFullscreen"),a.fullScreenTrigger&&$(a.fullScreenTrigger).show();var e=$(".map-fs-dummy"),t=setInterval(function(){n.container.fitToViewport()},1);$(".map-fullscreen-overlay").removeClass("ready"),setTimeout(function(){$(".map-fullscreen-overlay").remove()},400),l.parent().animate({width:e.width(),height:e.height(),top:e.offset().top-$(document).scrollTop(),left:e.offset().left},s,function(){l.parent().css({top:0,left:0}),l.parent().removeClass("map-fullscreen"),e.remove(),clearInterval(t),$("html,body").css("overflow","auto"),n.container.fitToViewport(),a.onFullscreenExit()}),n.container.fitToViewport()},this.getIconTypeNameByCount=function(e){return 1==e?"dot":e>1&&10>e?"circle_small":e>=10&&1e3>e?"circle_medium":e>=1e3&&1e4>e?"circle_big":e>=1e4&&1e5>e?"circle_jumbo":e>=1e5?"circle_titan":"default"},this.createClusterer=function(e,o){function i(){var e=n.zoomRange.getCurrent()[1],t=n.getZoom();return t>=e}function l(e){return r(e)}function s(e,t){var n='<div class="'+(e>15?"map-cluster-big":"map-cluster")+'">'+e+"</div>";return ymaps.templateLayoutFactory.createClass(n)}var r=function(e){var n=p(t.getIconTypeNameByCount(e));return[n,n]},f=0;o||(o=[]),a.clustererCountOfItems?_.each(o,function(e){f+=parseInt(e.options.get("counter"))}):f=o.length,c=new ymaps.Clusterer({clusterIcons:l(f),clusterNumbers:[15],clusterIconContentLayout:s(f),clusterDisableClickZoom:!1,openBalloonOnClick:!1,zoomMargin:50,gridSize:55,margin:55,minClusterSize:a.minClusterSize,clusterDisableClickZoom:a.disableClickZoomCluster}),n.geoObjects.add(c),c.createCluster=function(e,t){var o=ymaps.Clusterer.prototype.createCluster.call(this,e,t),i=0;a.disableClickZoomCluster&&(a.goToFirstRelevantClusterUrl?o.events.add("click",function(){var e=0,n=0,o=0;_.each(t,function(t){var i=parseInt(t.options.get("counter"));i>e&&(i=e,o=n),n++}),document.location.href=t[o].options.get("url")}):o.events.add("click",function(){n.setZoom(n.getZoom()+1)})),a.clustererCountOfItems?_.each(t,function(e){i+=parseInt(e.options.get("counter"))}):i=t.length;var c=l(i);return o.options.set("icons",c),o.options.set("iconContentLayout",s(i,c[0].size)),o}},this.init=function(){"undefined"!=typeof ymaps?(f(),a.onInit(t)):$.getScript("http://api-maps.yandex.ru/2.0-stable/?load=package.full&lang=ru-RU",function(){ymaps.ready(function(){f(),a.onInit(t)})})}};