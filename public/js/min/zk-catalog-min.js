var ZKCatalog={};ZKCatalog.Search=function(){this.init=function(){function e(e,t){r.set("query",e),r.set("items",t),$("#search-result .search-selector li:first").addClass("active")}function t(e){return e=$.trim(e),e=e.replace(/[^а-яА-ЯёЁa-zA-Z0-9 ]/gi,""),e.replace(/\s{2,}/g," "),e}function a(e,t){var a=e.split(" "),n="";a.sort(function(e,t){return t.length-e.length});for(var i=0,r=a.length;r>i;i++){var s=new RegExp(a[i],"gi");n=t.replace(s,function(e){return"<span>"+e+"</span>"})}return n}function n(a){a&&a.length>1?ZKCatalog.data.getObjects(function(n){if(n.success){var i=n.objects,r=_.filter(i,function(e){if(e.name&&e.name.length>2){var n=e.name.toLowerCase(),i=a.toLowerCase();if(i=t(i),n=t(n),n.search(i)>0&&n&&n.length>2)return{name:e.name,url:e.url}}});e(a,r)}else e(a,[])}):e(a,[])}var i={},r=new Ractive({el:"#search-result",template:'<ul class="search-selector {{#if items.length > 0}}active{{/if}}">{{#items}}<li on-click="goUrl">{{{name}}}</li>{{/items}}</ul>',data:{query:"",items:[]}});r.on("goUrl",function(e){document.location.href=e.context.url});var s=new UIClickOutside($("#search-result"),function(){r.set("query",""),r.set("items",[])});return s.bind(),$(document).on("keydown.searchResultNavigate",function(e){var t=$("#search-result .search-selector li"),a=t.filter(".active");if(a.length>0)switch(e.keyCode){case 40:a.next().length>0&&(a.next().addClass("active"),a.removeClass("active"));break;case 38:a.prev().length>0&&(a.prev().addClass("active"),a.removeClass("active"));break;case 13:a.click()}else t.filter(":first").addClass("active")}),$(".search-string-zk input.entry").on("keyup",function(e){n(27==e.keyCode?"":$(this).val())}),this}},ZKCatalog.Data=function(e,t){var a=null,n=null;this.getCurrentObject=function(t){return n?t(n):void $.ajax({url:"json/zk.json?r_id="+e,data:{},dataType:"json",success:function(e){n=e,t(e)}})},this.getObjects=function(n){return a?n(a):void $.ajax({url:"json/zk_objects.json?r_id="+e+"&type_id="+t,data:{},dataType:"json",success:function(e){a=e,n(e)}})}},ZKCatalog.Map=function(){$(".zk-catalog-block").KVLoadingElement({overlay:!0,invert:!0}),this.init=function(){var e=$(".map-zk-catalog").data();if(e&&e.center){var t=new GeoMap({id:"map-zk-catalog",fullScreenTrigger:"#fullscreen-trigger",zoom:10,clusterer:!0,controls:!0,center:e.center,onInit:function(e){ZKCatalog.data.getObjects(function(a){a.success&&_.each(a.objects,function(e){new t.Pin({type:"basic_small",center:[parseFloat(e.lat),parseFloat(e.lon)],zoomRelatedIcon:!0,zoomRelatedIconFactor:12,content:'<a href="'+e.url+'">'+e.name+"</a>"})}),e.fitCluster(),setTimeout(function(){$(".filter-string").addClass("active"),$(".zk-catalog-block").KVLoadingElement("stop"),$("#fullscreen-trigger").css({opacity:1})},500)})}});t.init()}return this}},ZKCatalog.init=function(){var e=$(".map-zk-catalog");this.data=new this.Data(e.data("region_id"),e.data("type_id")),this.map=(new this.Map).init(),this.search=(new this.Search).init()},$(function(){ZKCatalog.init()});